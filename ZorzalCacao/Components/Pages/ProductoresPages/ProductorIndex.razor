@page "/Productor/Index"
@inject RecogidasService recogidaService
@inject ZonasProduccionService zonaService
@inject AuthenticationStateProvider AuthenticationStateProvider

@rendermode InteractiveServer


@attribute [Authorize(Roles = "Productor")]

<PageTitle>Productores</PageTitle>

<!-- Stats Title -->
<div class="container section-title" data-aos="fade-up">
    <h2 style="font-weight: 700; font-size: 32px; color: #222;">Estadísticas del Productor</h2>
    <p style="color: #555; font-size: 16px;">
        Resumen general de las operaciones relacionadas al productor
    </p>
</div>

<!-- Stats Section -->
<section id="stats" class="stats section">
    <div class="container" data-aos="fade-up" data-aos-delay="100">
        <div class="row justify-content-center" style="gap: 30px;">

            <div class="col-auto">
                <div class="stats-item stats-box">
                    <i class="bi bi-hourglass-split"></i>
                    <span data-purecounter-start="0" data-purecounter-end="12" data-purecounter-duration="1" class="purecounter"></span>
                    <p><strong>Recogidas Pendientes</strong></p>
                    <span class="description">Aún no completadas</span>
                </div>
            </div><!-- End Stats Item -->

            <div class="col-auto">
                <div class="stats-item stats-box">
                    <i class="bi bi-check2-circle"></i>
                    <span data-purecounter-start="0" data-purecounter-end="25" data-purecounter-duration="1" class="purecounter"></span>
                    <p><strong>Recogidas Entregadas</strong></p>
                    <span class="description">Completadas exitosamente</span>
                </div>
            </div><!-- End Stats Item -->

            <div class="col-auto">
                <div class="stats-item stats-box">
                    <i class="bi bi-geo-alt"></i>
                    <span data-purecounter-start="0" data-purecounter-end="8" data-purecounter-duration="1" class="purecounter"></span>
                    <p><strong>Zonas de Producción</strong></p>
                    <span class="description">Áreas de cobertura</span>
                </div>
            </div><!-- End Stats Item -->

        </div>
    </div>
</section><!-- /Stats Section -->
<!-- Services Section -->
<section id="servicesE" class="services section">

    <div class="container section-title" data-aos="fade-up">
        <h2 style="font-weight: 700; font-size: 32px;">Servicios para Productores</h2>
        <p style="font-size: 16px; color: #555;">
            Consulta rápida y detallada de todas las recogidas asociadas al productor para un mejor seguimiento y control.
        </p>
    </div>

    <div class="container">
        <div class="row gy-4">

            <div class="col-lg-4 col-md-6 service-item d-flex" data-aos="fade-up" data-aos-delay="100">
                <div class="icon flex-shrink-0"><i class="bi bi-search"></i></div>
                <div>
                    <h4 class="title">
                        <a href="/RecogidaP/Index" class="stretched-link">Consulta de Recogidas</a>
                    </h4>
                    <p class="description">
                        Revisa todas tus recogidas, verifica estados, fechas, cantidades y seguimiento detallado de cada una.
                    </p>
                </div>
            </div><!-- End Service Item -->

            <div class="col-lg-4 col-md-6 service-item d-flex" data-aos="fade-up" data-aos-delay="200">
                <div class="icon flex-shrink-0"><i class="bi bi-geo-alt"></i></div>
                <div>
                    <h4 class="title">
                        <a href="/Zonas/Index" class="stretched-link">Zonas de Producción</a>
                    </h4>
                    <p class="description">
                        Consulta y gestiona tus zonas de producción, incluyendo ubicación, provincia y distancia desde el centro de acopio.
                    </p>
                </div>
            </div><!-- End Service Item -->


        </div>
    </div>
</section><!-- /Services Section -->

<footer id="footer" class="footer position-relative light-background">
    <div class="container">
        <div class="copyright text-center ">
            <p>© <span>Copyright</span> <strong class="px-1 sitename">iPortfolio</strong> <span>All Rights Reserved</span></p>
        </div>
        <div class="credits">
            Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a> Distributed by <a href="https://themewagon.com">ThemeWagon</a>
        </div>
    </div>
</footer>

<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
</a>

@code {
    public List<Recogidas> ListaPendientes = new List<Recogidas>();

    public List<Recogidas> ListaCompletadas = new List<Recogidas>();

    public List<ZonasProduccion> ListaZonas = new List<ZonasProduccion>();

    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        ListaPendientes = await recogidaService.Listar(r => r.EstadoEntrega == "Pendiente");
        ListaCompletadas = await recogidaService.Listar(r => r.EstadoEntrega == "Entregada");

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (!string.IsNullOrEmpty(userId))
            {
                ListaZonas = await zonaService.Listar(z => z.ProductorId == userId);
            }
            else
            {
                ListaZonas = new List<ZonasProduccion>();
            }
        }
        else
        {
            ListaZonas = new List<ZonasProduccion>();
        }
    }

}